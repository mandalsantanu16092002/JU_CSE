#include <sys/mman.h>
#include <stdio.h>
#include <sys/wait.h>
#include <stdlib.h>
#include <unistd.h>
#include <semaphore.h>
#include <time.h>
int main()
{
    sem_t *mm = (sem_t*)mmap(NULL, 4*sizeof(sem_t), PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, -1, 0);
    if(mm == MAP_FAILED){
    printf("Mapping Failed\n");
    return 1;
    }

    int fd[2];
    if(pipe(fd)<0) {return 2;}
    int id = fork(), id2;
    if(id==0) id2 = fork();
    if(id!=0){
        //Process X
        if(sem_init(mm, 1, 2)<0){return 2;}
        if(sem_init(mm+1, 1, 1)<0){return 2;}
        if(sem_init(mm+2, 1, 1)<0){return 2;}
        if(sem_init(mm+3, 1, 2)<0){return 2;}

        srand(time(NULL));
        for(int i=0; i<10; i++)
        {
            sem_wait(mm+3);
            sem_wait(mm+3);
            printf("\nPID %dX: Iteration no %d\n", getpid(), i+1);
            sleep(rand()%5);
            sem_post(mm);
            sem_post(mm);
        }
        wait(NULL);
    }
    else{
        if(id2!=0){
        //Process Y

        srand(time(NULL));
        for(int i=0; i<10; i++)
        {
            sem_wait(mm);
            sem_wait(mm+1);
            printf("\nPID %dY: Iteration no %d\n", getpid(), i+1);
            sleep(rand()%5);
            sem_post(mm+2);
            sem_post(mm+3);
        }
        wait(NULL);
        }
        else{
            //Process Z
            srand(time(NULL));
            for(int i=0; i<10; i++)
            {
                sem_wait(mm);
                sem_wait(mm+2);
            printf("\nPID %dZ: Iteration no %d\n", getpid(), i+1);
            sleep(rand()%5);
            sem_post(mm+1);
            sem_post(mm+3);
            }
        }
    }
    return 0;
}